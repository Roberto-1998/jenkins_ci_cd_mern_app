pipeline {
    agent any

    tools {
        nodejs 'NODE18'
    }

    environment {
        IMAGE_PREFIX = 'masterdevopscloud'
        DOCKERHUB_CREDENTIALS = 'dockerhublogin'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'jenkins', url:'https://github.com/Roberto-1998/jenkins_ci_cd_mern_app.git'
            }
        }

        stage('Install Backend Dependencies') {
            steps {
                dir('mern_blog_app/server') {
                    sh 'npm ci || npm install || yarn install'
                }
            }
        }

/*         stage('Backend Dependency Audit') {
            steps {
                dir('mern_blog_app/server') {
                    sh 'npm audit --audit-level=high'
                }
            }
        } */

        stage('Lint Backend') {
            steps {
                dir('mern_blog_app/server') {
                    sh 'npm run lint'
                }
            }
        }

        stage('Run Backend Tests') {
            steps {
                dir('mern_blog_app/server') {
                    sh 'npm test -- --watchAll=false || echo "No backend tests yet"'
                }
            }
        }

        stage('Install Frontend Dependencies') {
            steps {
                dir('mern_blog_app/client') {
                    sh 'npm ci || npm install || yarn install'
                }
            }
        }

/*         stage('Frontend Dependency Audit') {
            steps {
                dir('mern_blog_app/client') {
                    sh 'npm audit --audit-level=high'
                }
            }
        } */

        stage('Lint Frontend') {
            steps {
                dir('mern_blog_app/client') {
                    sh 'npm run lint'
                }
            }
        }

        stage('Run Frontend Tests') {
            steps {
                dir('mern_blog_app/client') {
                    sh 'npm test -- --watchAll=false || echo "No frontend tests yet"'
                }
            }
        }

        stage('Build Frontend App') {
            steps {
                dir('mern_blog_app/client') {
                    sh 'npm run build'
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'mern_blog_app/client/build/**', fingerprint: true
                }
            }
        }

        stage('Docker Build & Push - Backend') {
            steps {
                script {
                    def COMMIT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    def TS = (env.BUILD_TIMESTAMP ?: sh(script: 'date -u +%Y%m%d%H%M%S', returnStdout: true).trim())
                    def BRANCH = (env.BRANCH_NAME ?: 'jenkins').toLowerCase().replaceAll(/[^a-z0-9_.-]/, '-')
                    def TAG = "${BRANCH}-${COMMIT}-${TS}"

                    def imageName = "${env.IMAGE_PREFIX}/mern-backend"
                    dir('mern_blog_app/server') {
                        def img = docker.build("${imageName}:${TAG}")
                        docker.withRegistry('https://index.docker.io/v1/', env.DOCKERHUB_CREDENTIALS) {
                            img.push(TAG)
                            img.push(BRANCH)
                            img.push('latest')
                        }
                    }
                }
            }
            post {
                always {
                    sh 'docker image prune -f || true'
                }
            }
        }

        stage('Docker Build & Push - Frontend') {
            steps {
                script {
                    def COMMIT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    def TS = (env.BUILD_TIMESTAMP ?: sh(script: 'date -u +%Y%m%d%H%M%S', returnStdout: true).trim())
                    def BRANCH = (env.BRANCH_NAME ?: 'jenkins').toLowerCase().replaceAll(/[^a-z0-9_.-]/, '-')
                    def TAG = "${BRANCH}-${COMMIT}-${TS}"

                    def imageName = "${env.IMAGE_PREFIX}/mern-frontend"

                    dir('mern_blog_app/client') {
                        def img = docker.build("${imageName}:${TAG}")
                        docker.withRegistry('https://index.docker.io/v1/', env.DOCKERHUB_CREDENTIALS ) {
                            img.push(TAG)
                            img.push(BRANCH)
                            img.push('latest')
                        }
                    }
                }
            }
            post {
                always {
                    sh 'docker image prune -f || true'
                }
            }
        }

        stage('CD - Smoke Kube Access') {
            steps {
                withKubeConfig(credentialsId: 'kubeconfig-jenkins') {
                    sh 'kubectl config current-context && kubectl get nodes'
                }
            }
        }

        stage('CD - Helm Upgrade') {
            steps {
                withKubeConfig(credentialsId: 'kubeconfig-jenkins') {
                    sh '''
                        set -e
                        helm upgrade --install mern deploy/helm/mern -n default \
                             --set backend_app.image.name=docker.io/${IMAGE_PREFIX}/mern-backend \
                             --set backend_app.image.tag=latest \
                             --set frontend_app.image.name=docker.io/${IMAGE_PREFIX}/mern-frontend \
                             --set frontend_app.image.tag=latest \
                             --set backend_app.resources.requests.cpu=50m \
                             --set backend_app.resources.requests.memory=128Mi \
                             --set frontend_app.resources.requests.cpu=50m \
                             --set frontend_app.resources.requests.memory=64Mi \
                             --set db_app.resources.requests.cpu=100m \
                             --set db_app.resources.requests.memory=256Mi \
                             --wait --timeout 5m
                        '''
                }
            }
        }

        stage('Post-Deploy Checks') {
            steps {
                withKubeConfig(credentialsId: 'kubeconfig-jenkins') {
                    sh '''
        set -e

        echo "=== Rollout status ==="
        kubectl rollout status deploy/backend-deployment  -n default --timeout=180s
        kubectl rollout status deploy/frontend-deployment -n default --timeout=180s

        echo "=== Services & Endpoints (resumen) ==="
        kubectl get svc -n default
        kubectl get endpoints -n default

        echo "=== Ingress ==="
        # Mostramos el ingress por nombre y, si no existe con ese nombre, listamos todos
        kubectl get ingress mern-app-ingress -n default -o wide || kubectl get ingress -n default -o wide

        echo "=== Smoke Test (sin TLS) ==="
        # Si aún no propagó DNS o la app tarda en levantar, el curl puede fallar; no rompemos el build aquí
        (curl -f --max-time 15 http://mernapp.rcginfo.xyz/ \
          || curl -I --max-time 15 http://mernapp.rcginfo.xyz/) || true
      '''
                }
            }
            post {
                always {
                    withKubeConfig(credentialsId: 'kubeconfig-jenkins') {
                        sh '''
          echo "=== Helm release status ==="
          helm status mern || true

          echo "=== Pods (estado) ==="
          kubectl get pods -o wide -n default || true

          echo "=== Últimos eventos (debug rápido) ==="
          kubectl get events -n default --sort-by=.lastTimestamp | tail -n 50 || true
        '''
                    }
                }
            }
        }
    }
}
